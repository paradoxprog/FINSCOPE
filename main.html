<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINSCOPE - Your Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Custom CSS for theme and animations -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light gray background */
        }
        .gradient-text {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Simple loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            -webkit-animation: spin 2s linear infinite; /* Safari */
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @-webkit-keyframes spin {
          0% { -webkit-transform: rotate(0deg); }
          100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md shadow-sm">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="./index.html" class="text-2xl font-bold tracking-wider gradient-text">FINSCOPE</a>
            <div id="user-nav" class="hidden items-center space-x-4">
                 <p id="user-greeting" class="text-gray-600 hidden sm:block"></p>
                 <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <main>
        <!-- 1. Financial Input Section -->
        <section id="financial-input" class="py-20 bg-white">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900">Your Financial Profile</h2>
                    <p class="mt-2 text-gray-600">Provide your details to get personalized AI-powered advice.</p>
                </div>
                <div class="max-w-3xl mx-auto bg-gray-50 p-8 rounded-xl shadow-inner">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="monthlyIncome" class="block text-sm font-medium text-gray-700">Monthly Income (after tax)</label>
                            <input type="number" id="monthlyIncome" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="3000">
                        </div>
                        <div>
                            <label for="currentSavings" class="block text-sm font-medium text-gray-700">Current Savings</label>
                            <input type="number" id="currentSavings" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="10000">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Monthly Expenses</label>
                            <div class="grid grid-cols-2 gap-4 mt-1">
                                <input type="number" id="housing" class="w-full p-2 border rounded-md" placeholder="Housing">
                                <input type="number" id="food" class="w-full p-2 border rounded-md" placeholder="Food">
                                <input type="number" id="transport" class="w-full p-2 border rounded-md" placeholder="Transport">
                                <input type="number" id="other" class="w-full p-2 border rounded-md" placeholder="Other">
                            </div>
                        </div>
                         <div class="md:col-span-2">
                            <label for="financialGoals" class="block text-sm font-medium text-gray-700">Financial Goals</label>
                            <textarea id="financialGoals" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Buy a house in 5 years, save for retirement, pay off debt."></textarea>
                        </div>
                    </div>
                    <button id="analyzeBtn" class="mt-6 w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">Save & Analyze Profile</button>
                    <div id="analysisResult" class="mt-6 p-6 bg-white rounded-lg min-h-[100px] border border-gray-200">
                        <p class="text-gray-500">Your financial analysis will appear here...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. "What If?" Simulation Section -->
        <section id="simulation" class="py-20">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900">Simulate Future Scenarios</h2>
                    <p class="mt-2 text-gray-600">Ask "what if" and see the future impact on your finances instantly.</p>
                </div>
                <div class="max-w-3xl mx-auto bg-gray-50 p-8 rounded-xl shadow-inner">
                    <label for="scenarioInput" class="block text-lg font-medium text-gray-700">Your "What If" Question:</label>
                    <div class="mt-2 flex flex-col sm:flex-row gap-4">
                        <input type="text" id="scenarioInput" class="flex-grow w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., What if I get a 10% raise?" disabled>
                        <button id="simulateBtn" class="bg-green-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50" disabled>Simulate</button>
                    </div>
                    <div id="simulationResult" class="mt-6 p-6 bg-white rounded-lg min-h-[100px] border border-gray-200">
                        <p class="text-gray-500">Your simulation result will appear here...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. Chat Section -->
        <section id="chat" class="py-20 bg-white">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900">Chat With Your Twin</h2>
                    <p class="mt-2 text-gray-600">Talk to your Twin like a smart financial advisor, anytime.</p>
                </div>
                <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg">
                    <div class="p-4 border-b">
                        <h3 class="text-lg font-semibold">Your Financial Twin</h3>
                        <p class="text-sm text-green-500 flex items-center"><span class="h-2 w-2 bg-green-500 rounded-full mr-2"></span>Online</p>
                    </div>
                    <div id="chatBox" class="p-6 h-80 overflow-y-auto bg-gray-50">
                        <div class="flex justify-start mb-4">
                            <div class="bg-gray-200 text-gray-800 p-3 rounded-lg max-w-xs">
                                Hello! Please fill out your financial profile above to get started. Once that's done, I can help you with any questions.
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t flex">
                        <input type="text" id="chatInput" placeholder="Ask your Twin a question..." class="flex-grow px-4 py-2 rounded-l-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                        <button id="sendChatBtn" class="bg-blue-600 text-white px-6 py-2 rounded-r-lg hover:bg-blue-700 transition-colors disabled:opacity-50" disabled>Send</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyD6iB5gh_4arp0UkqILCFRgXq4KRFmDpAY",
            authDomain: "finscope-282b3.firebaseapp.com",
            projectId: "finscope-282b3",
            storageBucket: "finscope-282b3.firebasestorage.app",
            messagingSenderId: "838937656151",
            appId: "1:838937656151:web:85cfddd9dd86b39d4cdc12",
            measurementId: "G-R8GE51ZT8J"
        };
        
        // The API key is an empty string; the environment will provide it.
        const GEMINI_API_KEY = ""; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- DOM ELEMENTS ---
        const userNav = document.getElementById('user-nav');
        const userGreeting = document.getElementById('user-greeting');
        const logoutBtn = document.getElementById('logout-btn');
        
        // Financial Profile
        const monthlyIncome = document.getElementById('monthlyIncome');
        const currentSavings = document.getElementById('currentSavings');
        const housing = document.getElementById('housing');
        const food = document.getElementById('food');
        const transport = document.getElementById('transport');
        const other = document.getElementById('other');
        const financialGoals = document.getElementById('financialGoals');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analysisResult = document.getElementById('analysisResult');

        // Simulation
        const scenarioInput = document.getElementById('scenarioInput');
        const simulateBtn = document.getElementById('simulateBtn');
        const simulationResult = document.getElementById('simulationResult');

        // Chat
        const chatBox = document.getElementById('chatBox');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');

        // --- STATE ---
        let userFinancialProfile = null;
        let chatHistory = [];

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userNav.classList.remove('hidden');
                userNav.classList.add('flex');
                userGreeting.textContent = `Hello, ${user.displayName || user.email}`;
            } else {
                window.location.href = './index.html'; 
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => console.error('Sign Out Error', error));
        });

        // --- GEMINI API HELPER with Exponential Backoff ---
        async function callGemini(prompt, retries = 3, delay = 1000) {
            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) { // Rate limited
                        await new Promise(res => setTimeout(res, delay));
                        return callGemini(prompt, retries - 1, delay * 2); 
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API call failed with status: ${response.status}`);
                }

                const data = await response.json();
                if (data.candidates && data.candidates.length > 0) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    return "I'm not sure how to respond to that. Could you try rephrasing?";
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return callGemini(prompt, retries - 1, delay * 2);
                }
                return `Sorry, I encountered an error after several retries: ${error.message}`;
            }
        }
        
        // --- FEATURE LOGIC ---

        // 1. Financial Profile Analysis
        analyzeBtn.addEventListener('click', async () => {
            const profile = {
                income: monthlyIncome.value,
                savings: currentSavings.value,
                expenses: {
                    housing: housing.value,
                    food: food.value,
                    transport: transport.value,
                    other: other.value
                },
                goals: financialGoals.value
            };

            if (!profile.income || !profile.savings || !profile.goals) {
                analysisResult.innerHTML = `<p class="text-red-500">Please fill in all required fields: Income, Savings, and Goals.</p>`;
                return;
            }

            userFinancialProfile = profile;
            analysisResult.innerHTML = '<div class="loader"></div>';
            analyzeBtn.disabled = true;

            const prompt = `
                Analyze the following financial profile. Provide a concise summary of their financial health, 
                followed by 3 actionable, personalized recommendations in a bulleted list.

                **Profile:**
                - Monthly Income (after tax): $${profile.income}
                - Current Savings: $${profile.savings}
                - Monthly Expenses: Housing: $${profile.expenses.housing || 0}, Food: $${profile.expenses.food || 0}, Transport: $${profile.expenses.transport || 0}, Other: $${profile.expenses.other || 0}
                - Financial Goals: "${profile.goals}"

                Format the response in simple HTML (e.g., <p>, <strong>, <ul>, <li>).
            `;

            const result = await callGemini(prompt);
            analysisResult.innerHTML = result;
            analyzeBtn.disabled = false;

            if (!result.toLowerCase().includes('error')) {
                scenarioInput.disabled = false;
                simulateBtn.disabled = false;
                chatInput.disabled = false;
                sendChatBtn.disabled = false;
            }
        });

        // 2. Simulation
        simulateBtn.addEventListener('click', async () => {
            const scenario = scenarioInput.value;
            if (!scenario || !userFinancialProfile) return;

            simulationResult.innerHTML = '<div class="loader"></div>';
            simulateBtn.disabled = true;

            const prompt = `
                Given the user's financial profile:
                - Monthly Income: $${userFinancialProfile.income}
                - Current Savings: $${userFinancialProfile.savings}
                - Monthly Expenses Total: $${Object.values(userFinancialProfile.expenses).reduce((a, b) => Number(a) + Number(b), 0)}
                - Goals: "${userFinancialProfile.goals}"

                Simulate the financial impact of this scenario: "${scenario}".
                
                Provide a brief, clear analysis of the potential outcome in simple HTML.
            `;
            
            const result = await callGemini(prompt);
            simulationResult.innerHTML = result;
            simulateBtn.disabled = false;
        });

        // 3. Chat
        const handleSendChat = async () => {
            const message = chatInput.value.trim();
            if (!message || !userFinancialProfile) return;

            addMessageToChatbox(message, 'user');
            chatInput.value = '';
            sendChatBtn.disabled = true;

            chatHistory.push({ role: 'user', parts: [{ text: message }] });

            const prompt = `
                You are a helpful AI financial advisor, a "Financial Twin".
                User's profile:
                - Income: $${userFinancialProfile.income}/month
                - Savings: $${userFinancialProfile.savings}
                - Goals: "${userFinancialProfile.goals}"

                Conversation history is provided below. Respond to the last user message. Be conversational and concise.
                ${chatHistory.map(msg => `${msg.role}: ${msg.parts[0].text}`).join('\n')}
            `;

            const result = await callGemini(prompt);
            
            addMessageToChatbox(result, 'ai');
            chatHistory.push({ role: 'model', parts: [{ text: result }] });
            sendChatBtn.disabled = false;

            if (chatHistory.length > 10) {
                chatHistory = chatHistory.slice(-10);
            }
        };

        sendChatBtn.addEventListener('click', handleSendChat);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSendChat();
            }
        });

        function addMessageToChatbox(text, sender) {
            const messageWrapper = document.createElement('div');
            const messageBubble = document.createElement('div');
            
            messageWrapper.classList.add('flex', 'mb-4');
            messageBubble.classList.add('p-3', 'rounded-lg', 'max-w-xs');

            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageBubble.classList.add('bg-blue-500', 'text-white');
            } else {
                messageWrapper.classList.add('justify-start');
                messageBubble.classList.add('bg-gray-200', 'text-gray-800');
            }
            
            messageBubble.innerHTML = text; // Use innerHTML to render HTML from API
            messageWrapper.appendChild(messageBubble);
            chatBox.appendChild(messageWrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

    </script>
</body>
</html>
