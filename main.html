<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINSCOPE - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .blinking-cursor {
            display: inline-block;
            width: 8px;
            height: 1rem;
            background-color: #333;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { background-color: transparent }
            50% { background-color: #333; }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-blue-600 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12B2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10S2 17.523 2 12z"></path><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"></path><path d="M12 14c-2.67 0-8 1.33-8 4v2h16v-2c0-2.67-5.33-4-8-4z"></path></svg>
                FINSCOPE
            </a>
            <div class="flex items-center gap-4">
                <span id="user-display" class="text-gray-600 font-medium"></span>
            </div>
        </nav>
    </header>

    <main>
        <!-- 1. Financial Input Section -->
        <section id="financial-input" class="py-20 bg-white">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900">Your Financial Profile</h2>
                    <p class="mt-2 text-gray-600">Provide your details to get personalized AI-powered advice.</p>
                </div>
                <div class="max-w-3xl mx-auto bg-gray-50 p-8 rounded-xl shadow-inner">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="monthlyIncome" class="block text-sm font-medium text-gray-700">Monthly Income (after tax)</label>
                            <input type="number" id="monthlyIncome" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="3000">
                        </div>
                        <div>
                            <label for="currentSavings" class="block text-sm font-medium text-gray-700">Current Savings</label>
                            <input type="number" id="currentSavings" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="10000">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Monthly Expenses</label>
                            <div class="grid grid-cols-2 gap-4 mt-1">
                                <input type="number" id="housing" class="w-full p-2 border rounded-md" placeholder="Housing">
                                <input type="number" id="food" class="w-full p-2 border rounded-md" placeholder="Food">
                                <input type="number" id="transport" class="w-full p-2 border rounded-md" placeholder="Transport">
                                <input type="number" id="other" class="w-full p-2 border rounded-md" placeholder="Other">
                            </div>
                        </div>
                         <div class="md:col-span-2">
                            <label for="financialGoals" class="block text-sm font-medium text-gray-700">Financial Goals</label>
                            <textarea id="financialGoals" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Buy a house in 5 years, save for retirement, pay off debt."></textarea>
                        </div>
                    </div>
                    <button id="analyzeBtn" class="mt-6 w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50" disabled>Save & Analyze Profile</button>
                    <div id="analysisResult" class="mt-6 p-6 bg-white rounded-lg min-h-[100px] border border-gray-200">
                        <p class="text-gray-500">Your financial analysis will appear here...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. "What If?" Simulation Section -->
        <section id="simulation" class="py-20">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900">Simulate Future Scenarios</h2>
                    <p class="mt-2 text-gray-600">Ask "what if" and see the future impact on your finances instantly.</p>
                </div>
                <div class="max-w-3xl mx-auto bg-gray-50 p-8 rounded-xl shadow-inner">
                    <label for="scenarioInput" class="block text-lg font-medium text-gray-700">Your "What If" Question:</label>
                    <div class="mt-2 flex flex-col sm:flex-row gap-4">
                        <input type="text" id="scenarioInput" class="flex-grow w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., What if I get a 10% raise?" disabled>
                        <button id="simulateBtn" class="bg-green-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50" disabled>Simulate</button>
                    </div>
                    <div id="simulationResult" class="mt-6 p-6 bg-white rounded-lg min-h-[100px] border border-gray-200">
                        <p class="text-gray-500">Your simulation result will appear here...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. Chat Section -->
        <section id="chat" class="py-20 bg-white">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900">Chat With Your Twin</h2>
                    <p class="mt-2 text-gray-600">Talk to your Twin like a smart financial advisor, anytime.</p>
                </div>
                <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg">
                    <div class="p-4 border-b">
                        <h3 class="text-lg font-semibold">Your Financial Twin</h3>
                        <p class="text-sm text-green-500 flex items-center"><span class="h-2 w-2 bg-green-500 rounded-full mr-2"></span>Online</p>
                    </div>
                    <div id="chatBox" class="p-6 h-80 overflow-y-auto bg-gray-50">
                        <div class="flex justify-start mb-4">
                            <div class="bg-gray-200 text-gray-800 p-3 rounded-lg max-w-xs">
                                Hello! Please fill out your financial profile above to get started. Once that's done, I can help you with any questions.
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t flex">
                        <input type="text" id="chatInput" placeholder="Ask your Twin a question..." class="flex-grow px-4 py-2 rounded-l-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                        <button id="sendChatBtn" class="bg-blue-600 text-white px-6 py-2 rounded-r-lg hover:bg-blue-700 transition-colors disabled:opacity-50" disabled>Send</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white">
        <div class="container mx-auto px-6 py-8 text-center">
            <p>&copy; 2024 FINSCOPE. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State ---
        let userFinancialProfile = null;
        let db;
        let currentUserId;

        // --- UI Element References ---
        const userDisplay = document.getElementById('user-display');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analysisResult = document.getElementById('analysisResult');
        const simulateBtn = document.getElementById('simulateBtn');
        const scenarioInput = document.getElementById('scenarioInput');
        const simulationResult = document.getElementById('simulationResult');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const chatBox = document.getElementById('chatBox');
        
        // --- Main Application Logic ---
        try {
            const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            const firebaseConfig = JSON.parse(firebaseConfigString);
            if (!firebaseConfig.apiKey) throw new Error("Firebase config is missing.");

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userDisplay.textContent = `Welcome, ${user.displayName || user.email}!`;
                    await loadFinancialProfile();
                    enableAllInputs();
                } else {
                    const newUrl = new URL('index.html', window.location.href).href;
                    window.location.href = newUrl;
                }
            });
        } catch (error) {
            console.error("Fatal Error during initialization:", error);
            document.body.innerHTML = `<div class="text-center p-8 text-red-500"><h1 class="text-2xl font-bold">Application Error</h1><p>Could not initialize. Check console.</p></div>`;
        }
        
        // --- Gemini API Integration ---
        const apiKey = "AIzaSyCQpluFQok4C0jkqbQIMRKat434aF4zvXY";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        async function callGemini(prompt) {
            // Redacted for brevity, same robust function as before
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                 const errorBody = await response.json();
                 console.error("API Error:", errorBody);
                 return `Error: ${errorBody.error.message}`;
            }
            const result = await response.json();
            return result.candidates[0]?.content?.parts[0]?.text || "Sorry, I couldn't get a response.";
        }

        // --- Feature 1: Financial Profile Logic ---
        const financialInputs = {
            monthlyIncome: document.getElementById('monthlyIncome'),
            currentSavings: document.getElementById('currentSavings'),
            housing: document.getElementById('housing'),
            food: document.getElementById('food'),
            transport: document.getElementById('transport'),
            other: document.getElementById('other'),
            financialGoals: document.getElementById('financialGoals')
        };

        async function saveFinancialProfile() {
            if (!currentUserId) return;
            const profileData = {
                monthlyIncome: financialInputs.monthlyIncome.value,
                currentSavings: financialInputs.currentSavings.value,
                expenses: {
                    housing: financialInputs.housing.value,
                    food: financialInputs.food.value,
                    transport: financialInputs.transport.value,
                    other: financialInputs.other.value,
                },
                financialGoals: financialInputs.financialGoals.value
            };
            const profileRef = doc(db, "users", currentUserId, "financialProfile", "data");
            await setDoc(profileRef, profileData, { merge: true });
            userFinancialProfile = profileData; // Update global state
            return profileData;
        }

        async function loadFinancialProfile() {
            if (!currentUserId) return;
            const profileRef = doc(db, "users", currentUserId, "financialProfile", "data");
            const docSnap = await getDoc(profileRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                userFinancialProfile = data;
                financialInputs.monthlyIncome.value = data.monthlyIncome || '';
                financialInputs.currentSavings.value = data.currentSavings || '';
                financialInputs.housing.value = data.expenses?.housing || '';
                financialInputs.food.value = data.expenses?.food || '';
                financialInputs.transport.value = data.expenses?.transport || '';
                financialInputs.other.value = data.expenses?.other || '';
                financialInputs.financialGoals.value = data.financialGoals || '';
            }
        }

        async function handleAnalysis() {
            analysisResult.innerHTML = '<p class="text-gray-500 animate-pulse">Analyzing your profile...</p>';
            const profileData = await saveFinancialProfile();
            const prompt = `Analyze the following financial profile and provide a concise summary of the user's financial health, along with 3 actionable tips. Be encouraging and clear. Profile: ${JSON.stringify(profileData)}`;
            const resultText = await callGemini(prompt);
            analysisResult.innerHTML = `<div class="text-gray-700">${resultText.replace(/\n/g, '<br>')}</div>`;
        }

        // --- Feature 2: Simulation Logic ---
        async function handleSimulation() {
            const query = scenarioInput.value.trim();
            if (query === '') {
                simulationResult.innerHTML = '<p class="text-red-500">Please enter a scenario.</p>';
                return;
            }
            if (!userFinancialProfile) {
                simulationResult.innerHTML = '<p class="text-red-500">Please save your financial profile first.</p>';
                return;
            }
            simulationResult.innerHTML = '<p class="text-gray-500 animate-pulse">Simulating scenario...</p>';
            const prompt = `Given this financial profile: ${JSON.stringify(userFinancialProfile)}. Now, analyze this "what-if" scenario: "${query}". Provide a clear, concise analysis with bullet points on the potential impact.`;
            const resultText = await callGemini(prompt);
            simulationResult.innerHTML = `<div class="text-gray-700">${resultText.replace(/\n/g, '<br>')}</div>`;
        }
        
        // --- Feature 3: Chat Logic ---
        const addMessage = (message, sender) => {
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('p-3', 'rounded-lg', 'max-w-xs', 'mb-4');
            if (sender === 'user') {
                bubbleDiv.classList.add('bg-blue-600', 'text-white', 'self-end');
                bubbleDiv.textContent = message;
            } else {
                bubbleDiv.classList.add('bg-gray-200', 'text-gray-800', 'self-start');
                bubbleDiv.innerHTML = message;
            }
            chatBox.appendChild(bubbleDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        };
        
        async function handleChatSend() {
            const userMessage = chatInput.value.trim();
            if (userMessage === '') return;
            if (!userFinancialProfile) {
                addMessage("Please save your financial profile before we can chat!", 'twin');
                return;
            }
            addMessage(userMessage, 'user');
            chatInput.value = '';
            chatInput.disabled = true;
            sendChatBtn.disabled = true;

            addMessage(`<span class="blinking-cursor"></span>`, 'twin');
            const typingIndicator = chatBox.lastElementChild;
            
            const prompt = `You are a friendly AI financial twin. Use the user's financial profile as context: ${JSON.stringify(userFinancialProfile)}. Now, answer their question: "${userMessage}"`;
            const twinResponse = await callGemini(prompt);
            
            typingIndicator.remove();
            addMessage(twinResponse.replace(/\n/g, '<br>'), 'twin');

            chatInput.disabled = false;
            sendChatBtn.disabled = false;
            chatInput.focus();
        }
        
        // --- General Functions & Event Listeners ---
        function enableAllInputs() {
            Object.values(financialInputs).forEach(input => input.disabled = false);
            analyzeBtn.disabled = false;
            simulateBtn.disabled = false;
            scenarioInput.disabled = false;
            chatInput.disabled = false;
            sendChatBtn.disabled = false;
        }

        analyzeBtn.addEventListener('click', handleAnalysis);
        simulateBtn.addEventListener('click', handleSimulation);
        scenarioInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleSimulation(); });
        sendChatBtn.addEventListener('click', handleChatSend);
        chatInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleChatSend(); });
    </script>
</body>
</html>
