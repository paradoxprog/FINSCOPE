<!DOCTYPE html>
<html lang="en"><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINSCOPE - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .blinking-cursor {
            display: inline-block;
            width: 8px;
            height: 1rem;
            background-color: #333;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { background-color: transparent }
            50% { background-color: #333; }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-blue-600 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12B2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10S2 17.523 2 12z"></path><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"></path><path d="M12 14c-2.67 0-8 1.33-8 4v2h16v-2c0-2.67-5.33-4-8-4z"></path></svg>
                FINSCOPE
            </a>
            <div class="flex items-center gap-4">
                <span id="user-display" class="text-gray-600 font-medium">Loading...</span>
            </div>
        </nav>
    </header>

    <main>
        <!-- Simulation Section -->
        <section id="simulation" class="py-20 bg-white">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900">Simulate Future Scenarios</h2>
                    <p class="mt-2 text-gray-600">Ask "what if" and see the future impact on your finances instantly.</p>
                </div>
                <div class="max-w-3xl mx-auto bg-gray-50 p-8 rounded-xl shadow-inner">
                    <label for="scenarioInput" class="block text-lg font-medium text-gray-700">Your "What If" Question:</label>
                    <div class="mt-2 flex flex-col sm:flex-row gap-4">
                        <input type="text" id="scenarioInput" class="flex-grow w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., What if I buy a car for $25,000?" disabled>
                        <button id="simulateBtn" class="bg-green-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50" disabled>Simulate</button>
                    </div>
                    <div id="simulationResult" class="mt-6 p-6 bg-white rounded-lg min-h-[100px] border border-gray-200">
                        <p class="text-gray-500">Your simulation result will appear here...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Chat Section -->
        <section id="chat" class="py-20">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900">Chat With Your Twin</h2>
                    <p class="mt-2 text-gray-600">Talk to your Twin like a smart financial advisor, anytime.</p>
                </div>
                <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg">
                    <div class="p-4 border-b">
                        <h3 class="text-lg font-semibold">Your Financial Twin</h3>
                        <p class="text-sm text-green-500 flex items-center"><span class="h-2 w-2 bg-green-500 rounded-full mr-2"></span>Online</p>
                    </div>
                    <div id="chatBox" class="p-6 h-80 overflow-y-auto bg-gray-50">
                        <div class="flex justify-start mb-4">
                            <div class="bg-gray-200 text-gray-800 p-3 rounded-lg max-w-xs">
                                Hello! How can I help you with your finances today?
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t flex">
                        <input type="text" id="chatInput" placeholder="Ask your Twin a question..." class="flex-grow px-4 py-2 rounded-l-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                        <button id="sendChatBtn" class="bg-blue-600 text-white px-6 py-2 rounded-r-lg hover:bg-blue-700 transition-colors disabled:opacity-50" disabled>Send</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white">
        <div class="container mx-auto px-6 py-8 text-center">
            <p>&copy; 2024 FINSCOPE. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- UI Element References ---
        const userDisplay = document.getElementById('user-display');
        const simulateBtn = document.getElementById('simulateBtn');
        const scenarioInput = document.getElementById('scenarioInput');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const simulationResult = document.getElementById('simulationResult');
        const chatBox = document.getElementById('chatBox');

        // --- Main Application Logic ---
        try {
            // --- Firebase Initialization ---
            const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            const firebaseConfig = JSON.parse(firebaseConfigString);

            if (!firebaseConfig.apiKey) {
                throw new Error("Firebase configuration is missing or invalid. App cannot start.");
            }

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);

            // --- Auth State Management ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    // User is signed in.
                    userDisplay.textContent = `Welcome, ${user.displayName || user.email}!`;
                    // Enable UI elements now that user is logged in
                    simulateBtn.disabled = false;
                    scenarioInput.disabled = false;
                    chatInput.disabled = false;
                    sendChatBtn.disabled = false;
                } else {
                    // No user is signed in, redirect to the landing page.
                    const newUrl = new URL('index.html', window.location.href).href;
                    window.location.href = newUrl;
                }
            });

        } catch (error) {
            console.error("Fatal Error during initialization:", error);
            document.body.innerHTML = `<div class="text-center p-8 text-red-500">
                <h1 class="text-2xl font-bold">Application Error</h1>
                <p>Could not initialize the application. Please check the console for more details.</p>
            </div>`;
        }


        // --- Gemini API Integration ---
        const apiKey = "AIzaSyCQpluFQok4C0jkqbQIMRKat434aF4zvXY";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        async function callGemini(prompt) {
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            let retries = 3;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error("API Error Response:", errorBody);
                        throw new Error(`API request failed with status ${response.status}: ${errorBody.error.message}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                         throw new Error("Invalid response structure from API.");
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        return `Sorry, there was a problem contacting the AI service after multiple attempts. Please check the API key and try again later. Error: ${error.message}`;
                    }
                }
            }
        }

        // --- Simulation Logic ---
        const handleSimulation = async () => {
            const query = scenarioInput.value.trim();
            if (query === '') {
                simulationResult.innerHTML = '<p class="text-red-500">Please enter a scenario to simulate.</p>';
                return;
            }

            simulationResult.innerHTML = '<p class="text-gray-500 animate-pulse">Your Twin is analyzing the scenario...</p>';
            const prompt = `As a financial expert AI, analyze the following scenario for a user and provide a concise, easy-to-understand summary of the potential impacts on their finances. Use bullet points for key takeaways. Scenario: "${query}"`;
            const resultText = await callGemini(prompt);
            simulationResult.innerHTML = `<div class="text-gray-700">${resultText.replace(/\n/g, '<br>')}</div>`;
        };

        // --- Chat Logic ---
        const addMessage = (message, sender) => {
            const messageDiv = document.createElement('div');
            const bubbleDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'mb-4');
            bubbleDiv.classList.add('p-3', 'rounded-lg', 'max-w-xs');
            
            if (sender === 'user') {
                messageDiv.classList.add('justify-end');
                bubbleDiv.classList.add('bg-blue-600', 'text-white');
                bubbleDiv.textContent = message;
            } else {
                messageDiv.classList.add('justify-start');
                bubbleDiv.classList.add('bg-gray-200', 'text-gray-800');
                bubbleDiv.innerHTML = message;
            }
            
            messageDiv.appendChild(bubbleDiv);
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        };
        
        const handleChatSend = async () => {
            const userMessage = chatInput.value.trim();
            if (userMessage === '') return;

            addMessage(userMessage, 'user');
            chatInput.value = '';
            chatInput.disabled = true;
            sendChatBtn.disabled = true;

            addMessage(`<span class="font-medium">Financial Twin is typing</span><span class="blinking-cursor ml-1"></span>`, 'twin');
            const typingIndicator = chatBox.lastElementChild;

            const prompt = `You are a friendly and helpful AI financial twin. Answer the following user question concisely and in a conversational tone. User question: "${userMessage}"`;
            const twinResponse = await callGemini(prompt);
            
            typingIndicator.remove();
            addMessage(twinResponse.replace(/\n/g, '<br>'), 'twin');

            chatInput.disabled = false;
            sendChatBtn.disabled = false;
            chatInput.focus();
        };

        // --- Event Listeners ---
        simulateBtn.addEventListener('click', handleSimulation);
        scenarioInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleSimulation(); });
        sendChatBtn.addEventListener('click', handleChatSend);
        chatInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleChatSend(); });
    </script>
</body>
</html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINSCOPE - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .blinking-cursor {
            display: inline-block;
            width: 8px;
            height: 1rem;
            background-color: #333;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { background-color: transparent }
            50% { background-color: #333; }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-blue-600 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12B2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10S2 17.523 2 12z"></path><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"></path><path d="M12 14c-2.67 0-8 1.33-8 4v2h16v-2c0-2.67-5.33-4-8-4z"></path></svg>
                FINSCOPE
            </a>
            <div class="flex items-center gap-4">
                <span id="user-display" class="text-gray-600 font-medium"></span>
            </div>
        </nav>
    </header>

    <main>
        <!-- Simulation Section -->
        <section id="simulation" class="py-20 bg-white">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900">Simulate Future Scenarios</h2>
                    <p class="mt-2 text-gray-600">Ask "what if" and see the future impact on your finances instantly.</p>
                </div>
                <div class="max-w-3xl mx-auto bg-gray-50 p-8 rounded-xl shadow-inner">
                    <label for="scenarioInput" class="block text-lg font-medium text-gray-700">Your "What If" Question:</label>
                    <div class="mt-2 flex flex-col sm:flex-row gap-4">
                        <input type="text" id="scenarioInput" class="flex-grow w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., What if I buy a car for $25,000?">
                        <button id="simulateBtn" class="bg-green-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50" disabled>Simulate</button>
                    </div>
                    <div id="simulationResult" class="mt-6 p-6 bg-white rounded-lg min-h-[100px] border border-gray-200">
                        <p class="text-gray-500">Your simulation result will appear here...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Chat Section -->
        <section id="chat" class="py-20">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-900">Chat With Your Twin</h2>
                    <p class="mt-2 text-gray-600">Talk to your Twin like a smart financial advisor, anytime.</p>
                </div>
                <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg">
                    <div class="p-4 border-b">
                        <h3 class="text-lg font-semibold">Your Financial Twin</h3>
                        <p class="text-sm text-green-500 flex items-center"><span class="h-2 w-2 bg-green-500 rounded-full mr-2"></span>Online</p>
                    </div>
                    <div id="chatBox" class="p-6 h-80 overflow-y-auto bg-gray-50">
                        <div class="flex justify-start mb-4">
                            <div class="bg-gray-200 text-gray-800 p-3 rounded-lg max-w-xs">
                                Hello! How can I help you with your finances today?
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t flex">
                        <input type="text" id="chatInput" placeholder="Ask your Twin a question..." class="flex-grow px-4 py-2 rounded-l-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                        <button id="sendChatBtn" class="bg-blue-600 text-white px-6 py-2 rounded-r-lg hover:bg-blue-700 transition-colors disabled:opacity-50" disabled>Send</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white">
        <div class="container mx-auto px-6 py-8 text-center">
            <p>&copy; 2024 FINSCOPE. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Initialization ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- Auth State Management ---
        const userDisplay = document.getElementById('user-display');
        const simulateBtn = document.getElementById('simulateBtn');
        const scenarioInput = document.getElementById('scenarioInput');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');

        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in.
                userDisplay.textContent = `Welcome, ${user.displayName || user.email}!`;
                // Enable UI elements now that user is logged in
                simulateBtn.disabled = false;
                scenarioInput.disabled = false;
                chatInput.disabled = false;
                sendChatBtn.disabled = false;
            } else {
                // No user is signed in, redirect to the landing page.
                window.location.href = './index.html';
            }
        });

        // --- Gemini API Integration ---
        const apiKey = "AIzaSyCQpluFQok4C0jkqbQIMRKat434aF4zvXY";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        /**
         * Calls the Gemini API with a given prompt and handles retries with exponential backoff.
         * @param {string} prompt The text prompt to send to the API.
         * @returns {Promise<string>} The generated text response from the API.
         */
        async function callGemini(prompt) {
            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            let responseText = "Sorry, I couldn't process that request. Please try again.";
            let retries = 3;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        responseText = result.candidates[0].content.parts[0].text;
                        return responseText; // Success, exit the loop
                    } else {
                         throw new Error("Invalid response structure from API.");
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
            }
            return responseText; // Return default error message after all retries fail
        }


        // --- Simulation Logic ---
        const simulationResult = document.getElementById('simulationResult');

        simulateBtn.addEventListener('click', async () => {
            const query = scenarioInput.value.trim();
            if (query === '') {
                simulationResult.innerHTML = '<p class="text-red-500">Please enter a scenario to simulate.</p>';
                return;
            }

            simulationResult.innerHTML = '<p class="text-gray-500 animate-pulse">Your Twin is analyzing the scenario...</p>';
            
            const prompt = `As a financial expert AI, analyze the following scenario for a user and provide a concise, easy-to-understand summary of the potential impacts on their finances. Use bullet points for key takeaways. Scenario: "${query}"`;

            const resultText = await callGemini(prompt);
            simulationResult.innerHTML = `<div class="text-gray-700">${resultText.replace(/\n/g, '<br>')}</div>`;
        });
        scenarioInput.addEventListener('keydown', e => { if (e.key === 'Enter') simulateBtn.click(); });

        // --- Chat Logic ---
        const chatBox = document.getElementById('chatBox');

        const addMessage = (message, sender) => {
            const messageDiv = document.createElement('div');
            const bubbleDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'mb-4');
            bubbleDiv.classList.add('p-3', 'rounded-lg', 'max-w-xs');
            
            if (sender === 'user') {
                messageDiv.classList.add('justify-end');
                bubbleDiv.classList.add('bg-blue-600', 'text-white');
                bubbleDiv.textContent = message;
            } else {
                messageDiv.classList.add('justify-start');
                bubbleDiv.classList.add('bg-gray-200', 'text-gray-800');
                // For AI, we might have HTML content
                bubbleDiv.innerHTML = message;
            }
            
            messageDiv.appendChild(bubbleDiv);
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        };
        
        const handleChatSend = async () => {
            const userMessage = chatInput.value.trim();
            if (userMessage === '') return;

            addMessage(userMessage, 'user');
            chatInput.value = '';
            chatInput.disabled = true;
            sendChatBtn.disabled = true;

            // Add a typing indicator
            const typingIndicatorId = `typing-${Date.now()}`;
            addMessage(`<span class="font-medium">Financial Twin is typing</span><span class="blinking-cursor ml-1"></span>`, 'twin');
            const typingIndicator = chatBox.lastElementChild;

            const prompt = `You are a friendly and helpful AI financial twin. Answer the following user question concisely and in a conversational tone. User question: "${userMessage}"`;
            const twinResponse = await callGemini(prompt);
            
            // Remove typing indicator and add final response
            typingIndicator.remove();
            addMessage(twinResponse.replace(/\n/g, '<br>'), 'twin');

            chatInput.disabled = false;
            sendChatBtn.disabled = false;
            chatInput.focus();
        };

        sendChatBtn.addEventListener('click', handleChatSend);
        chatInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleChatSend(); });
    </script>
</body>
</html>
