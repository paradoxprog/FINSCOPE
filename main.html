<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINSCOPE - Financial AI Twin</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: cover;
            background-attachment: fixed;
            color: #1f2937;
        }
        
        /* Glassmorphism Card Style */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .gradient-text {
            background: linear-gradient(135deg, #4f46e5, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            box-shadow: 0 10px 20px -10px rgba(79, 70, 229, 0.5);
            transform: translateY(-2px);
        }

        /* Custom Scrollbar for Chat */
        .chat-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .chat-scroll::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 8px;
        }
        .chat-scroll::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 8px;
        }
        .chat-scroll::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }

        /* Loader */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="sticky top-0 z-50 glass-card border-b border-white/20">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="flex items-center gap-3 group">
                <div class="bg-indigo-600 p-2 rounded-lg shadow-lg group-hover:rotate-12 transition-transform duration-300">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                </div>
                <span class="text-2xl font-bold tracking-tight text-gray-900">FIN<span class="text-indigo-600">SCOPE</span></span>
            </a>
            <div id="user-nav" class="hidden items-center space-x-6">
                 <p id="user-greeting" class="text-sm font-semibold text-gray-700 hidden sm:block"></p>
                 <button id="logout-btn" class="text-sm font-medium text-red-500 hover:text-red-700 transition-colors">
                    Sign Out
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-10 space-y-12">
        
        <div class="text-center max-w-2xl mx-auto space-y-4 mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white drop-shadow-sm">
                Your AI Financial <br /><span class="gradient-text bg-clip-text text-transparent bg-gradient-to-r from-indigo-300 to-purple-300">Digital Twin</span>
            </h1>
            <p class="text-gray-200 text-lg">Analyze your finances, simulate future scenarios, and chat with an intelligent advisor trained on your data.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <div class="lg:col-span-7 space-y-8">
                
                <section id="financial-input" class="glass-card rounded-3xl p-8 shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Financial Profile</h2>
                            <p class="text-sm text-gray-500">Input your current status to train your Twin.</p>
                        </div>
                        <div class="p-2 bg-indigo-50 rounded-full">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-1">
                            <label class="text-xs font-semibold uppercase tracking-wider text-gray-500">Monthly Income (Net)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-gray-400">‚Çπ</span>
                                <input type="number" id="monthlyIncome" class="w-full pl-8 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none font-medium" placeholder="50000">
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-semibold uppercase tracking-wider text-gray-500">Current Savings</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-gray-400">‚Çπ</span>
                                <input type="number" id="currentSavings" class="w-full pl-8 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none font-medium" placeholder="200000">
                            </div>
                        </div>
                        
                        <div class="md:col-span-2 space-y-2">
                            <label class="text-xs font-semibold uppercase tracking-wider text-gray-500">Monthly Expenses Breakdown</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <input type="number" id="housing" class="p-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-indigo-500 outline-none" placeholder="Housing ‚Çπ">
                                <input type="number" id="food" class="p-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-indigo-500 outline-none" placeholder="Food ‚Çπ">
                                <input type="number" id="transport" class="p-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-indigo-500 outline-none" placeholder="Transport ‚Çπ">
                                <input type="number" id="other" class="p-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-indigo-500 outline-none" placeholder="Other ‚Çπ">
                            </div>
                        </div>

                        <div class="md:col-span-2 space-y-1">
                            <label class="text-xs font-semibold uppercase tracking-wider text-gray-500">Financial Goals</label>
                            <textarea id="financialGoals" rows="2" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm" placeholder="e.g. Save for a house down payment in 3 years..."></textarea>
                        </div>
                    </div>

                    <button id="analyzeBtn" class="btn-primary mt-8 w-full py-3.5 rounded-xl font-bold text-white flex justify-center items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        Initialize Financial Twin
                    </button>

                    <div id="analysisResult" class="mt-6 p-5 bg-indigo-50/50 border border-indigo-100 rounded-xl text-sm text-gray-700 min-h-[60px] opacity-0 transition-opacity duration-500"></div>
                </section>

                <section id="simulation" class="glass-card rounded-3xl p-8 shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-cyan-500"></div>
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-2 bg-emerald-50 rounded-full">
                            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">Future Simulator</h2>
                    </div>

                    <div class="bg-white/60 p-1 rounded-xl border border-gray-200 flex flex-col sm:flex-row gap-2">
                        <input type="text" id="scenarioInput" class="flex-grow bg-transparent px-4 py-3 outline-none text-gray-800 placeholder-gray-400" placeholder="e.g. What if I invest ‚Çπ5k/month in mutual funds?" disabled>
                        <button id="simulateBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Simulate
                        </button>
                    </div>
                    
                    <div id="simulationResult" class="mt-4 p-5 bg-white rounded-xl border border-gray-100 shadow-inner min-h-[80px] text-sm text-gray-600">
                        <span class="italic text-gray-400">Results will appear here after analysis...</span>
                    </div>
                </section>
            </div>

            <div class="lg:col-span-5">
                <section id="chat" class="glass-card rounded-3xl shadow-2xl h-[600px] flex flex-col relative overflow-hidden border border-white/40">
                    
                    <div class="p-5 border-b border-gray-100 bg-white/50 backdrop-blur-md flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold">
                                    AI
                                </div>
                                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800">FinScope Twin</h3>
                                <p class="text-xs text-indigo-600 font-medium">Online & Analyzing</p>
                            </div>
                        </div>
                    </div>

                    <div id="chatBox" class="flex-grow p-6 overflow-y-auto chat-scroll bg-gradient-to-b from-white/30 to-white/60 space-y-4">
                        <div class="flex justify-start">
                            <div class="bg-white border border-gray-100 text-gray-700 p-4 rounded-2xl rounded-tl-none shadow-sm max-w-[85%] text-sm leading-relaxed">
                                üëã <strong>Welcome!</strong> I'm your Financial Twin. Once you fill out your profile on the left, I'll be trained on your data and ready to answer complex questions!
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-white border-t border-gray-100">
                        <div class="relative flex items-center">
                            <input type="text" id="chatInput" placeholder="Ask a financial question..." class="w-full pl-4 pr-14 py-4 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm transition-all" disabled>
                            <button id="sendChatBtn" class="absolute right-2 p-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-5 h-5 transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyD6iB5gh_4arp0UkqILCFRgXq4KRFmDpAY",
            authDomain: "finscope-282b3.firebaseapp.com",
            projectId: "finscope-282b3",
            storageBucket: "finscope-282b3.firebasestorage.app",
            messagingSenderId: "838937656151",
            appId: "1:838937656151:web:85cfddd9dd86b39d4cdc12",
            measurementId: "G-R8GE51ZT8J"
        };
        
        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- DOM ELEMENTS ---
        const userNav = document.getElementById('user-nav');
        const userGreeting = document.getElementById('user-greeting');
        const logoutBtn = document.getElementById('logout-btn');
        
        const monthlyIncome = document.getElementById('monthlyIncome');
        const currentSavings = document.getElementById('currentSavings');
        const housing = document.getElementById('housing');
        const food = document.getElementById('food');
        const transport = document.getElementById('transport');
        const other = document.getElementById('other');
        const financialGoals = document.getElementById('financialGoals');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analysisResult = document.getElementById('analysisResult');

        const scenarioInput = document.getElementById('scenarioInput');
        const simulateBtn = document.getElementById('simulateBtn');
        const simulationResult = document.getElementById('simulationResult');

        const chatBox = document.getElementById('chatBox');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');

        // --- STATE ---
        let userFinancialProfile = null;
        let chatHistory = [];

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userNav.classList.remove('hidden');
                userNav.classList.add('flex');
                userGreeting.textContent = `Hi, ${user.displayName ? user.displayName.split(' ')[0] : 'User'}`;
            } else {
                // If this is the main dashboard, redirect to login is usually handled here
                // window.location.href = './index.html'; 
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => console.error('Sign Out Error', error));
        });

        // --- SECURE API HELPER ---
        async function callGemini(prompt, retries = 3, delay = 1000) {
            const API_URL = '/api/gemini'; 

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) { 
                        await new Promise(res => setTimeout(res, delay));
                        return callGemini(prompt, retries - 1, delay * 2); 
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.error || `API call failed: ${response.status}`);
                }

                const data = await response.json();
                if (data.candidates && data.candidates.length > 0) {
                    let rawText = data.candidates[0].content.parts[0].text;
                    let cleanedText = rawText.trim();
                    if (cleanedText.startsWith('```html')) {
                        cleanedText = cleanedText.substring(7);
                        if (cleanedText.endsWith('```')) cleanedText = cleanedText.slice(0, -3);
                    } else if (cleanedText.toLowerCase().startsWith('html')) {
                        cleanedText = cleanedText.substring(4);
                    }
                    return cleanedText.trim();
                } else {
                    return "I didn't quite get that. Could you try rephrasing?";
                }
            } catch (error) {
                console.error("API Error:", error);
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return callGemini(prompt, retries - 1, delay * 2);
                }
                return `Server Error: ${error.message}`;
            }
        }
        
        // --- LOGIC ---

        // 1. Analyze Profile
        analyzeBtn.addEventListener('click', async () => {
            const profile = {
                income: monthlyIncome.value,
                savings: currentSavings.value,
                expenses: {
                    housing: housing.value,
                    food: food.value,
                    transport: transport.value,
                    other: other.value
                },
                goals: financialGoals.value
            };

            if (!profile.income || !profile.savings || !profile.goals) {
                analysisResult.innerHTML = `<p class="text-red-500 font-semibold">‚ö†Ô∏è Please fill in Income, Savings, and Goals.</p>`;
                analysisResult.style.opacity = "1";
                return;
            }

            userFinancialProfile = profile;
            analysisResult.style.opacity = "1";
            analysisResult.innerHTML = '<div class="loader"></div><p class="text-center mt-2 text-indigo-600 animate-pulse">Building your Financial Twin...</p>';
            analyzeBtn.disabled = true;
            analyzeBtn.classList.add('opacity-75', 'cursor-wait');

            const prompt = `
                Analyze financial profile (INR):
                - Monthly Income: ‚Çπ${profile.income}
                - Savings: ‚Çπ${profile.savings}
                - Expenses: Housing: ${profile.expenses.housing}, Food: ${profile.expenses.food}, Transport: ${profile.expenses.transport}, Other: ${profile.expenses.other}
                - Goals: "${profile.goals}"

                Provide:
                1. A 2-sentence summary of financial health.
                2. 3 Actionable Bullet points using HTML (<ul>, <li>, <strong>).
            `;

            const result = await callGemini(prompt);
            analysisResult.innerHTML = result;
            analyzeBtn.disabled = false;
            analyzeBtn.classList.remove('opacity-75', 'cursor-wait');
            analyzeBtn.innerText = "Update Profile Analysis";

            if (!result.toLowerCase().includes('error')) {
                // Enable other sections
                scenarioInput.disabled = false;
                simulateBtn.disabled = false;
                chatInput.disabled = false;
                sendChatBtn.disabled = false;
                
                // Add initial AI message
                addMessageToChatbox("I've analyzed your profile! I'm ready to discuss your goals or run simulations.", 'ai');
            }
        });

        // 2. Simulate
        simulateBtn.addEventListener('click', async () => {
            const scenario = scenarioInput.value;
            if (!scenario || !userFinancialProfile) return;

            simulationResult.innerHTML = '<div class="loader"></div>';
            simulateBtn.disabled = true;

            const prompt = `
                Context: User earns ‚Çπ${userFinancialProfile.income}/mo, has ‚Çπ${userFinancialProfile.savings} saved.
                Goal: "${userFinancialProfile.goals}"
                
                Scenario to Simulate: "${scenario}".
                
                Output: A brief, direct analysis of the impact in simple HTML. Use bolding for key numbers.
            `;
            
            const result = await callGemini(prompt);
            simulationResult.innerHTML = result;
            simulateBtn.disabled = false;
        });

        // 3. Chat
        const handleSendChat = async () => {
            const message = chatInput.value.trim();
            if (!message || !userFinancialProfile) return;

            addMessageToChatbox(message, 'user');
            chatInput.value = '';
            sendChatBtn.disabled = true;

            chatHistory.push({ role: 'user', parts: [{ text: message }] });

            // Create placeholder for AI response
            const typingId = addMessageToChatbox('<div class="flex gap-1"><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div></div>', 'ai');

            const prompt = `
                Act as a "Financial Twin" advisor.
                Profile: Income ‚Çπ${userFinancialProfile.income}, Savings ‚Çπ${userFinancialProfile.savings}, Goal "${userFinancialProfile.goals}".
                History: ${chatHistory.map(msg => `${msg.role}: ${msg.parts[0].text}`).join('\n')}
                
                Respond to user in helpful, short HTML format.
            `;

            const result = await callGemini(prompt);
            
            // Replace typing indicator with actual message
            const bubble = document.getElementById(typingId);
            if(bubble) bubble.innerHTML = result;

            chatHistory.push({ role: 'model', parts: [{ text: result }] });
            sendChatBtn.disabled = false;

            if (chatHistory.length > 10) chatHistory = chatHistory.slice(-10);
        };

        sendChatBtn.addEventListener('click', handleSendChat);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSendChat();
        });

        function addMessageToChatbox(text, sender) {
            const messageWrapper = document.createElement('div');
            const messageBubble = document.createElement('div');
            const id = 'msg-' + Date.now();
            
            messageWrapper.classList.add('flex', 'mb-4', 'animate-fade-in-up'); // Add animation class if you have one, or just standard flex
            
            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageBubble.classList.add('bg-indigo-600', 'text-white', 'p-4', 'rounded-2xl', 'rounded-tr-none', 'max-w-[80%]', 'shadow-md', 'text-sm');
            } else {
                messageWrapper.classList.add('justify-start');
                messageBubble.classList.add('bg-white', 'border', 'border-gray-100', 'text-gray-700', 'p-4', 'rounded-2xl', 'rounded-tl-none', 'max-w-[85%]', 'shadow-sm', 'text-sm');
            }
            
            messageBubble.id = id;
            messageBubble.innerHTML = text;
            messageWrapper.appendChild(messageBubble);
            chatBox.appendChild(messageWrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
            return id;
        }

    </script>
</body>
</html>
